{% extends 'base.html' %}

{% block title %}Pré-visualização da Importação{% endblock %}

{% block content %}
<div class="dashboard-container" style="max-width: 95%;">
    <h1>Pré-visualização e Validação da Planilha</h1>
    <p>Corrija os erros diretamente na tabela abaixo. Role para o lado para ver todas as colunas.</p>
    
    <div style="margin-bottom: 20px; font-size: 0.9em; color: #666;">
        <span style="display:inline-block; width: 12px; height: 12px; background-color: #28a745; border-radius: 50%; margin-right: 5px;"></span> Linhas Verdes: Prontas para importar.
        <span style="display:inline-block; width: 12px; height: 12px; background-color: #dc3545; border-radius: 50%; margin-left: 15px; margin-right: 5px;"></span> Linhas Vermelhas: Precisam de correção.
    </div>

    <form action="{{ url_for('processar_edicao_csv') }}" method="post">
        
        <div class="table-responsive">
            <table class="preview-table">
                <thead>
                    <tr>
                        <th style="min-width: 100px;">Status</th>
                        {% for header in headers %}
                            <th>{{ header }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row_item in data %}
                        {% set row_index = loop.index0 %}
                        <tr>
                            <td class="{{ 'status-valid' if row_item.is_valid else 'status-invalid' }}">
                                {% if row_item.is_valid %} 
                                    ✔️ Válido 
                                {% else %} 
                                    ❌ Erro 
                                {% endif %}
                            </td>
                            
                            {% for key in headers %}
                                <td>
                                    {% if key in ['texto', 'explicacao', 'opcao_a', 'opcao_b', 'opcao_c', 'opcao_d'] %}
                                        <textarea 
                                            name="row-{{ row_index }}-{{ key }}" 
                                            class="preview-input {{ 'cell-error' if key in row_item.errors else '' }}"
                                            rows="3"
                                            title="{{ row_item.errors.get(key, '') }}"
                                        >{{ row_item.data.get(key, '') }}</textarea>
                                    {% else %}
                                        <input type="text" 
                                               name="row-{{ row_index }}-{{ key }}" 
                                               value="{{ row_item.data.get(key, '') }}"
                                               class="preview-input {{ 'cell-error' if key in row_item.errors else '' }}"
                                               title="{{ row_item.errors.get(key, '') }}">
                                    {% endif %}
                                           
                                    {% if key in row_item.errors %}
                                        <div style="color: #dc3545; font-size: 11px; margin-top: 4px; font-weight: bold;">
                                            {{ row_item.errors[key] }}
                                        </div>
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div style="margin-top: 30px; text-align: center;">
            <a href="{{ url_for('pagina_admin') }}" class="btn btn-secondary" style="margin-right: 10px;">Cancelar</a>
            <button type="submit" class="btn">Importar Perguntas Corrigidas</button>
        </div>
    </form>

</div>
{% endblock %}