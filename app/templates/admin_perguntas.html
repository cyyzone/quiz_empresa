{% extends 'base.html' %}

{% block title %}Gerenciar Perguntas{% endblock %}

{% block content %}
<div class="dashboard-container" style="max-width: 1100px;">
    <div style="text-align: left; margin-bottom: 20px;">
        <a href="{{ url_for('admin.pagina_admin') }}" class="btn btn-secondary">⬅️ Voltar ao Admin</a>
    </div>

    <h1>Gerenciar Perguntas</h1>

    <div style="text-align: left; max-width: 800px; margin: 20px auto; background-color: #f9f9f9; padding: 20px; border-radius: 8px;">
        <h3>Importar Perguntas (Planilha)</h3>
        <p style="font-size: 14px; margin-bottom: 20px;">
            <a href="{{ url_for('static', filename='downloads/template_importacao.xlsx') }}" download="template_importacao.xlsx" style="font-weight: bold;">
                ➡️ Baixar planilha modelo (.xlsx)
            </a>
        </p>
        <div class="import-instructions">
            <strong>Como preencher a planilha:</strong>
            <ul>
                <li><code>tipo</code>: multipla_escolha, verdadeiro_falso ou discursiva.</li>
                <li><code>resposta_correta</code>: a, b, c, d ou v/f.</li>
                <li><code>data_liberacao</code>: DD/MM/AAAA.</li>
                <li><code>explicacao</code>: Texto opcional.</li>
                <li><code>setor</code>: Nome do setor ou "Todos".</li>
            </ul>
        </div>
        <form action="{{ url_for('admin.upload_planilha') }}" method="post" enctype="multipart/form-data">
            <input type="file" name="arquivo_planilha" accept=".xls, .xlsx" required>
            <button type="submit" class="btn" style="margin-top: 10px;">Importar Planilha</button>
        </form>
    </div>
    
    <hr>
    
    <form action="{{ url_for('admin.adicionar_pergunta') }}" method="post" enctype="multipart/form-data" style="text-align: left; max-width: 800px; margin: 40px auto; background-color: #f9f9f9; padding: 20px; border-radius: 8px;">
        <h3>Cadastrar Nova Pergunta</h3>
        
        <label for="tipo">Tipo de Pergunta:</label><br>
        <select id="tipo-pergunta" name="tipo" required onchange="toggleQuestionFields()">
            <option value="multipla_escolha" selected>Múltipla Escolha</option>
            <option value="verdadeiro_falso">Verdadeiro ou Falso</option>
            <option value="discursiva">Discursiva</option>
        </select><br><br>

        <label for="texto">Texto da Pergunta:</label><br>
        <textarea name="texto" rows="3" style="width: 100%;" required></textarea><br><br>

        <label for="imagem_pergunta">Imagens de Exemplo (Opcional - Pode selecionar várias):</label><br>
        <input type="file" name="imagem_pergunta" accept="image/*" multiple><br><br>

        <div id="setores-alvo">
            <label>Setores Alvo:</label>
            <div style="background-color: #e9ecef; padding: 15px; border-radius: 8px;">
                <div>
                    <input type="checkbox" id="para_todos" name="para_todos_setores" value="sim" onchange="toggleAllSectors(this.checked)">
                    <label for="para_todos" style="font-weight: bold;">Para Todos os Setores</label>
                </div>
                <hr>
                <div id="lista-setores-checkboxes" style="max-height: 150px; overflow-y: auto;">
                    {% for depto in departamentos %}
                    <div>
                        <input type="checkbox" name="departamentos" value="{{ depto.id }}" id="depto-{{ depto.id }}">
                        <label for="depto-{{ depto.id }}">{{ depto.nome }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <br>

        <div id="campos-objetivos">
            <div id="campos-multipla-escolha">
                <label for="opcao_a">Opção A:</label><br>
                <input type="text" name="opcao_a" style="width: 100%;"><br><br>
                <label for="opcao_b">Opção B:</label><br>
                <input type="text" name="opcao_b" style="width: 100%;"><br><br>
                <label for="opcao_c">Opção C:</label><br>
                <input type="text" name="opcao_c" style="width: 100%;"><br><br>
                <label for="opcao_d">Opção D:</label><br>
                <input type="text" name="opcao_d" style="width: 100%;"><br><br>
            </div>
            <label for="resposta_correta">Resposta Correta:</label><br>
            <select id="resposta-multipla-escolha" name="resposta_correta">
                <option value="a">A</option><option value="b">B</option><option value="c">C</option><option value="d">D</option>
            </select>
            <select id="resposta-vf" name="resposta_correta_vf" style="display: none;">
                <option value="v">Verdadeiro</option><option value="f">Falso</option>
            </select><br><br>
            <label for="tempo_limite">Tempo em Segundos:</label><br>
            <input type="number" name="tempo_limite" value="30" min="5" style="width: 100px;"><br><br>
        </div>

        <label for="data_liberacao">Data de Liberação:</label><br>
        <input type="date" name="data_liberacao" required><br><br>

        <label for="explicacao">Explicação da Resposta (Opcional - aparece após o usuário responder):</label><br>
        <textarea name="explicacao" rows="3" style="width: 100%;" placeholder="Ex: A resposta é B porque..."></textarea><br><br>

        <button type="submit" class="btn">Salvar Pergunta</button>
    </form>

    <div class="ranking-container" style="max-width: 100%; margin: 40px auto;">
        <h3>Perguntas Cadastradas</h3>
        
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #dee2e6; text-align: left;">
            <form method="get" action="{{ url_for('admin.pagina_admin_perguntas') }}" style="display: flex; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="flex: 1 1 150px;">
                    <label for="filtro_mes" style="font-weight: bold;">Mês/Ano:</label>
                    <input type="month" name="filtro_mes" value="{{ filtros.mes or '' }}" style="width: 100%;">
                </div>
                <div style="flex: 1 1 200px;">
                    <label for="filtro_setor" style="font-weight: bold;">Setor:</label>
                    <select name="filtro_setor" style="width: 100%;">
                        <option value="">-- Todos --</option>
                        {% for depto in departamentos %}
                        <option value="{{ depto.id }}" {% if depto.id == filtros.setor_id %}selected{% endif %}>{{ depto.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="flex: 1 1 200px;">
                    <label for="filtro_tipo" style="font-weight: bold;">Tipo:</label>
                    <select name="filtro_tipo" style="width: 100%;">
                        <option value="">-- Todos --</option>
                        <option value="multipla_escolha" {% if 'multipla_escolha'==filtros.tipo %}selected{% endif %}>Múltipla Escolha</option>
                        <option value="verdadeiro_falso" {% if 'verdadeiro_falso'==filtros.tipo %}selected{% endif %}>Verdadeiro ou Falso</option>
                        <option value="discursiva" {% if 'discursiva'==filtros.tipo %}selected{% endif %}>Discursiva</option>
                    </select>
                </div>
                <div style="align-self: flex-end;">
                    <button type="submit" class="btn" style="padding: 10px 15px; margin: 0;">Filtrar</button>
                    <a href="{{ url_for('admin.pagina_admin_perguntas') }}" class="btn btn-secondary" style="padding: 10px 15px; margin: 0;">Limpar</a>
                </div>
            </form>
        </div>

        <div style="overflow-x: auto;">
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>Data Lib.</th>
                        <th>Pergunta</th>
                        <th>Explicação</th>
                        <th>Setor(es)</th>
                        <th>Resposta</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pergunta in perguntas.items %}
                    <tr>
                        <td>{{ pergunta.data_liberacao.strftime('%d/%m/%Y') }}</td>
                        <td style="white-space: normal; max-width: 300px;">{{ pergunta.texto }}</td>
                        <td style="white-space: normal; max-width: 250px; font-size: 0.9em; color: #555;">
                            {% if pergunta.explicacao %}
                                {{ pergunta.explicacao }}
                            {% else %}
                                <span style="color: #ccc;">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if pergunta.para_todos_setores %}
                            <span style="color: #6c757d;">(Todos)</span>
                            {% else %}
                            {{ pergunta.departamentos|map(attribute='nome')|join(', ') }}
                            {% endif %}
                        </td>
                        <td>
                            {% if pergunta.tipo != 'discursiva' %}
                            <b>{{ pergunta.resposta_correta.upper() if pergunta.resposta_correta else '' }}</b>
                            {% else %}
                            <span style="color: #6c757d;">(Discursiva)</span>
                            {% endif %}
                        </td>
                        <td style="display: flex; gap: 5px;">
                            <a href="{{ url_for('admin.editar_pergunta', pergunta_id=pergunta.id) }}" style="background-color: #ffc107; color: black; padding: 5px 10px; border-radius: 4px; font-size: 14px; text-decoration: none;">Editar</a>
                            <form action="{{ url_for('admin.excluir_pergunta', pergunta_id=pergunta.id) }}" method="post" onsubmit="return confirm('Tem certeza?');">
                                <button type="submit" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Excluir</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6">Nenhuma pergunta encontrada.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
            {% if perguntas.has_prev %}
                <a href="{{ url_for('admin.pagina_admin_perguntas', page=perguntas.prev_num, **filtros) }}" class="btn btn-secondary" style="padding: 5px 15px; font-size: 14px;">&laquo; Anterior</a>
            {% endif %}

            <span style="align-self: center; font-weight: bold;">
                Página {{ perguntas.page }} de {{ perguntas.pages }}
            </span>

            {% if perguntas.has_next %}
                <a href="{{ url_for('admin.pagina_admin_perguntas', page=perguntas.next_num, **filtros) }}" class="btn btn-secondary" style="padding: 5px 15px; font-size: 14px;">Próximo &raquo;</a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }} 
    <script>
    function toggleQuestionFields() {
        const tipo = document.getElementById('tipo-pergunta').value;
        const camposObjetivos = document.getElementById('campos-objetivos');
        const camposMultipla = document.getElementById('campos-multipla-escolha');
        const respostaMultipla = document.getElementById('resposta-multipla-escolha');
        const respostaVf = document.getElementById('resposta-vf');
        
        camposObjetivos.style.display = 'none';
        camposMultipla.style.display = 'none';
        respostaMultipla.style.display = 'none';
        respostaVf.style.display = 'none';
        
        if (tipo === 'multipla_escolha') {
            camposObjetivos.style.display = 'block';
            camposMultipla.style.display = 'block';
            respostaMultipla.style.display = 'block';
            respostaMultipla.name = 'resposta_correta';
            respostaVf.name = '';
        } else if (tipo === 'verdadeiro_falso') {
            camposObjetivos.style.display = 'block';
            respostaVf.style.display = 'block';
            respostaVf.name = 'resposta_correta';
            respostaMultipla.name = '';
        }
    }
    
    function toggleAllSectors(isChecked) {
        const checkboxes = document.querySelectorAll('#lista-setores-checkboxes input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.disabled = isChecked;
            if (isChecked) {
                cb.checked = false;
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        toggleQuestionFields();
        const paraTodosCheckbox = document.getElementById('para_todos');
        if (paraTodosCheckbox) {
            toggleAllSectors(paraTodosCheckbox.checked);
        }
    });
    
    const formCadastroPergunta = document.querySelector('form[action="{{ url_for('admin.adicionar_pergunta') }}"]');
    if (formCadastroPergunta) {
        formCadastroPergunta.addEventListener('submit', function(event) {
            const paraTodosCheckbox = document.getElementById('para_todos');
            const isParaTodosChecked = paraTodosCheckbox ? paraTodosCheckbox.checked : false;
            const setoresChecados = document.querySelectorAll('input[name="departamentos"]:checked');

            if (!isParaTodosChecked && setoresChecados.length === 0) {
                alert('Por favor, selecione pelo menos um setor ou marque a opção "Para Todos os Setores".');
                event.preventDefault();
            }
        });
    }
    </script>
{% endblock %}